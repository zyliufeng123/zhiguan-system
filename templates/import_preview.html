{% extends "base.html" %}
{% block title %}批量导入 - 映射与预览{% endblock %}
{% block content %}
<div class="container mt-3">
  <h4>映射与预览（报价单）</h4>
  <div id="info" class="mb-3"></div>

  <div class="mb-2">
    <label class="form-label">产品列（必填）</label>
    <input id="product_col" class="form-control" placeholder="列名或列索引（从0开始）" />
  </div>

  <div id="priceCols">
    <h6>价格列（可添加多个）</h6>
    <div class="mb-2 priceRow">
      <input class="form-control d-inline-block col-5 me-2 price_col" placeholder="列名或索引" />
      <input class="form-control d-inline-block col-4 me-2 company_input" placeholder="公司名（必填，当该列有价格时）" />
      <input class="form-control d-inline-block col-3 price_type" placeholder="价格类型（例如：中标价(默认)）" />
    </div>
  </div>
  <button id="addPriceCol" class="btn btn-sm btn-outline-secondary mb-3">添加价格列</button>

  <div class="mb-2">
    <label class="form-label">日期列（可选）</label>
    <input id="date_col" class="form-control" placeholder="列名或索引（若无则使用全局月份）" />
  </div>

  <div class="mb-2">
    <label class="form-label">全局中标月份（YYYY-MM，仅当文件无日期时使用）</label>
    <input id="global_month" class="form-control" placeholder="例如 2025-10" />
  </div>

  <div class="mb-3">
    <label class="form-label">相似度阈值（模糊匹配，0-100，默认90）</label>
    <input id="fuzzy_threshold" type="number" class="form-control" value="90" min="50" max="100" />
  </div>

  <div class="mb-3">
    <label class="form-label">冲突处理</label>
    <select id="conflict_mode" class="form-select">
      <option value="skip" selected>跳过已存在记录（默认）</option>
      <option value="overwrite">覆盖已存在记录</option>
      <option value="ask">询问（当前当作跳过）</option>
    </select>
  </div>

  <div class="mb-3">
    <button id="precheckBtn" class="btn btn-primary">预检</button>
    <button id="startBtn" class="btn btn-success">开始导入</button>
  </div>

  <pre id="result" class="small bg-light p-2"></pre>
</div>

<script>
function collectMapping(){
  const priceRows = Array.from(document.querySelectorAll('.priceRow'));
  const price_cols = priceRows.map(r => {
    return {
      col: r.querySelector('.price_col').value.trim(),
      company: r.querySelector('.company_input').value.trim(),
      price_type: r.querySelector('.price_type').value.trim()
    };
  }).filter(x=>x.col);
  return {
    product: document.getElementById('product_col').value.trim(),
    price_cols: price_cols,
    date_col: document.getElementById('date_col').value.trim(),
    global_month: document.getElementById('global_month').value.trim()
  };
}

document.getElementById('addPriceCol').onclick = function(){
  const div = document.createElement('div');
  div.className = 'mb-2 priceRow';
  div.innerHTML = '<input class="form-control d-inline-block col-5 me-2 price_col" placeholder="列名或索引" />' +
                  '<input class="form-control d-inline-block col-4 me-2 company_input" placeholder="公司名（必填，当该列有价格时）" />' +
                  '<input class="form-control d-inline-block col-3 price_type" placeholder="价格类型（例如：中标价(默认)）" />';
  document.getElementById('priceCols').appendChild(div);
};

async function apiPost(path, body){
  const res = await fetch(path, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return res.json();
}

const urlParams = new URLSearchParams(location.search);
const temp_id = urlParams.get('temp_id');
if(!temp_id){
  document.getElementById('info').innerText = '未提供 temp_id，请先上传文件。';
} else {
  document.getElementById('info').innerText = 'temp_id: ' + temp_id;
}

document.getElementById('precheckBtn').onclick = async function(){
  const mapping = collectMapping();
  const body = { temp_id: temp_id, mapping: mapping, fuzzy_threshold: parseInt(document.getElementById('fuzzy_threshold').value||90) };
  const j = await apiPost('/api/import/precheck', body);
  document.getElementById('result').innerText = JSON.stringify(j, null, 2);
};

document.getElementById('startBtn').onclick = async function(){
  if(!confirm('确定开始导入吗？请先完成预检并确认冲突策略。')) return;
  const mapping = collectMapping();
  const body = { temp_id: temp_id, mapping: mapping, conflict_mode: document.getElementById('conflict_mode').value };
  const j = await apiPost('/api/import/start', body);
  document.getElementById('result').innerText = JSON.stringify(j, null, 2);
  if(j.error_file){
    const link = document.createElement('a');
    link.href = '/uploads/' + j.error_file;
    link.innerText = '下载错误文件';
    link.target = '_blank';
    document.getElementById('result').appendChild(document.createElement('br'));
    document.getElementById('result').appendChild(link);
  }
};
</script>
{% endblock %}