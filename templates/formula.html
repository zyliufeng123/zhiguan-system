<!DOCTYPE html>
<html><head><title>公式编辑器</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
</head><body>
<!-- 顶部栏 -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">智管</a>
    <div class="navbar-nav ms-auto">
      <a class="nav-link" href="/smart_quote">返回智能报价</a>
      <a class="nav-link" href="/logout">退出</a>
    </div>
  </div>
</nav>

<!-- 左侧侧边栏 -->
<div class="sidebar d-none d-lg-block">
  <ul>
    <li><a href="/smart_quote">智能报价</a></li>
    <li><a href="/order">订单管理</a></li>
    <li><a href="/inventory">库存管理</a></li>
    <li><a href="/pivot">透视报表</a></li>
    <li><a href="/settings">系统设置</a></li>
  </ul>
</div>

<div class="container-fluid mt-3" style="margin-left: 250px; padding: 20px;">
  <h2>公式编辑器 (智能报价)</h2>
  <div class="card">
    <div class="card-body">
      <p class="text-muted">可用字段: {% for f in fields %}{{ '{' + f + '}' }} {% endfor %} (e.g., avg({price}) * 1.2)</p>
      <textarea id="expr" class="form-control" rows="5" placeholder="输入公式，如 avg({price}) * 1.2 + sum({qty})"></textarea>
      <div class="row mt-3">
        <div class="col-md-3">
          <label>测试产品ID:</label>
          <input type="number" id="test_pid" class="form-control" placeholder="e.g., 1">
        </div>
        <div class="col-md-9 text-end">
          <button onclick="testFormula()" class="btn btn-info me-2">预览测试</button>
          <button onclick="saveFormula()" class="btn btn-primary">保存公式</button>
        </div>
      </div>
      <div id="preview" class="mt-3 p-3 border rounded bg-light"></div>
    </div>
  </div>
</div>

<script>
function saveFormula() {
  const expr = document.getElementById('expr').value;
  if (!expr) {
    alert('请输入公式');
    return;
  }
  fetch('/api/formula/save', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({expr: expr})
  }).then(r => r.json()).then(data => {
    if (data.success) {
      alert('公式保存成功！');
    } else {
      alert('保存失败');
    }
  });
}

function testFormula() {
  const pid = document.getElementById('test_pid').value;
  const expr = document.getElementById('expr').value;
  if (!pid || !expr) {
    alert('请填产品ID和公式');
    return;
  }
  fetch(`/api/formula/eval/${pid}`).then(r => r.json()).then(data => {
    if (data.error) {
      document.getElementById('preview').innerHTML = `<div class="alert alert-danger">错误: ${data.error}</div>`;
    } else {
      document.getElementById('preview').innerHTML = `<pre class="bg-white p-2 rounded">结果: ${data.result.toFixed(2)}\n详情: ${JSON.stringify(data.details, null, 2)}</pre>`;
    }
  });
}
</script>
</body></html>