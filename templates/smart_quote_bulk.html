{% extends "base.html" %}

{% block title %}智能报价 - 批量导入{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>智能报价 - 批量导入</h2>
            
            {% if not temp_id %}
            <!-- 文件上传界面 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">选择文件</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">选择CSV或Excel文件</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".csv,.xls,.xlsx" required>
                            <div class="form-text">支持CSV、XLS、XLSX格式文件</div>
                        </div>
                        <button type="submit" class="btn btn-primary">上传并映射</button>
                        <a href="{{ url_for('smart_quote') }}" class="btn btn-secondary ms-2">返回</a>
                    </form>
                </div>
            </div>
            {% else %}
            <!-- 映射配置界面 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">文件: {{ temp_file_name }}</h5>
                    <small class="text-muted">共 {{ preview_data|length }} 行数据预览</small>
                </div>
                <div class="card-body">
                    
                    <!-- 数据预览 -->
                    {% if preview_data %}
                    <h6>数据预览（前5行）:</h6>
                    <div class="table-responsive mb-4">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    {% for col in columns %}
                                    <th>{{ col }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in preview_data %}
                                <tr>
                                    {% for col in columns %}
                                    <td>{{ row[col] if row[col] is not none else '' }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    <!-- 列映射配置 -->
                    <h6>列映射配置:</h6>
                    <form id="mappingForm" method="post" action="{{ url_for('smart_quote_bulk_import') }}">
                        <input type="hidden" name="temp_id" value="{{ temp_id }}">
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">产品名称列 <span class="text-danger">*</span></label>
                                <select name="product_col" class="form-select" required>
                                    <option value="">请选择...</option>
                                    {% for col in columns %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">价格列 <span class="text-danger">*</span></label>
                                <select name="price_col" class="form-select" required>
                                    <option value="">请选择...</option>
                                    {% for col in columns %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">公司列 <span class="text-danger">*</span></label>
                                <select name="company_col" class="form-select" required>
                                    <option value="">请选择...</option>
                                    {% for col in columns %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">日期列（可选）</label>
                                <select name="date_col" class="form-select">
                                    <option value="">请选择...</option>
                                    {% for col in columns %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">数量列（可选）</label>
                                <select name="qty_col" class="form-select">
                                    <option value="">请选择...</option>
                                    {% for col in columns %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">冲突处理</label>
                                <select name="conflict_mode" class="form-select">
                                    <option value="skip">跳过重复</option>
                                    <option value="overwrite">覆盖现有</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-success">开始导入</button>
                            <a href="{{ url_for('smart_quote_bulk') }}" class="btn btn-secondary ms-2">重新上传</a>
                            <a href="{{ url_for('smart_quote') }}" class="btn btn-outline-secondary ms-2">返回列表</a>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}