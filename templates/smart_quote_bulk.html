<!DOCTYPE html>
<html>
<head>
    <title>批量导入报价</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
        .preview-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .mapping-section {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .price-mapping {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>批量导入报价</h1>
        
        {% if not temp_id %}
        <!-- 上传表单 -->
        <div class="card">
            <div class="card-header">选择文件</div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="file">选择Excel或CSV文件：</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv,.xlsx,.xls">
                        <small class="form-text text-muted">支持的格式：CSV, Excel</small>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">上传</button>
                </form>
            </div>
        </div>
        {% else %}
        <!-- 映射界面 -->
        <div class="card">
            <div class="card-header">列映射</div>
            <div class="card-body">
                <div id="mapping-form">
                    <div class="form-group">
                        <label>文件名：{{ temp_file_name }}</label>
                    </div>
                    
                    <!-- 预览数据 -->
                    <div class="preview-table">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    {% for col in columns %}
                                    <th>{{ col }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in preview_data %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    {% for col in columns %}
                                    <td>{{ row[col] }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mapping-section">
                        <!-- 产品列映射 -->
                        <div class="form-group">
                            <label>产品列 <span class="text-danger">*</span></label>
                            <select class="form-control" id="product-column">
                                <option value="">请选择</option>
                                {% for col in columns %}
                                <option value="{{ col }}">{{ col }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 日期列映射 -->
                        <div class="form-group">
                            <label>日期列</label>
                            <select class="form-control" id="date-column">
                                <option value="">请选择</option>
                                {% for col in columns %}
                                <option value="{{ col }}">{{ col }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 全局日期（若无日期列） -->
                        <div class="form-group" id="global-date-container">
                            <label>全局中标月份 (YYYY-MM)</label>
                            <input type="month" class="form-control" id="global-month">
                        </div>
                        
                        <!-- 价格列映射 -->
                        <div class="form-group">
                            <label>价格列映射</label>
                            <button type="button" class="btn btn-sm btn-secondary" id="add-price-mapping">添加价格列</button>
                            <div id="price-mappings"></div>
                        </div>
                        
                        <!-- 冲突处理 -->
                        <div class="form-group">
                            <label>冲突处理策略</label>
                            <select class="form-control" id="conflict-mode">
                                <option value="skip">跳过（不覆盖已有数据）</option>
                                <option value="overwrite">覆盖（用新数据替换）</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="button" class="btn btn-primary" id="preview-btn">预检查</button>
                        <button type="button" class="btn btn-success" id="import-btn" disabled>开始导入</button>
                        <a href="/smart_quote/bulk" class="btn btn-secondary">取消</a>
                    </div>
                </div>
                
                <!-- 预检查结果 -->
                <div id="preview-results" class="mt-4" style="display:none;">
                    <h4>预检查结果</h4>
                    <div id="conflicts-container" class="alert alert-warning" style="display:none;">
                        <h5>发现冲突</h5>
                        <div id="conflicts-list"></div>
                    </div>
                    <div class="preview-table">
                        <table class="table table-bordered table-sm" id="preview-table">
                            <thead>
                                <tr>
                                    <th>行</th>
                                    <th>产品名称</th>
                                    <th>归一化名称</th>
                                    <th>匹配结果</th>
                                    <th>价格信息</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 导入进度 -->
                <div id="import-progress" class="mt-4" style="display:none;">
                    <div class="card">
                        <div class="card-header">导入进度</div>
                        <div class="card-body">
                            <div class="progress">
                                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-2">
                                <span id="progress-text">准备中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // 隐藏/显示全局日期
            $('#date-column').on('change', function() {
                if ($(this).val()) {
                    $('#global-date-container').hide();
                } else {
                    $('#global-date-container').show();
                }
            });
            
            // 添加价格映射
            $('#add-price-mapping').click(function() {
                const mappingId = Date.now();
                const html = `
                    <div class="price-mapping" id="price-map-${mappingId}">
                        <div class="row">
                            <div class="col">
                                <label>价格列</label>
                                <select class="form-control price-column">
                                    <option value="">请选择</option>
                                    {% for col in columns %}
                                    <option value="{{ col }}">{{ col }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col">
                                <label>公司名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control company-name" required>
                            </div>
                            <div class="col">
                                <label>价格类型</label>
                                <input type="text" class="form-control price-type" value="中标价(默认)">
                            </div>
                            <div class="col-auto">
                                <label>&nbsp;</label><br>
                                <button class="btn btn-danger remove-price-mapping" data-id="${mappingId}">删除</button>
                            </div>
                        </div>
                    </div>
                `;
                $('#price-mappings').append(html);
            });
            
            // 删除价格映射
            $(document).on('click', '.remove-price-mapping', function() {
                const id = $(this).data('id');
                $(`#price-map-${id}`).remove();
            });
            
            // 预检查
            $('#preview-btn').click(function() {
                // 验证必填项
                const productColumn = $('#product-column').val();
                if (!productColumn) {
                    alert('请选择产品列');
                    return;
                }
                
                // 收集价格映射
                const priceColumns = [];
                $('.price-mapping').each(function() {
                    const column = $(this).find('.price-column').val();
                    const company = $(this).find('.company-name').val();
                    const priceType = $(this).find('.price-type').val();
                    
                    if (column && company) {
                        priceColumns.push({
                            column: column,
                            company: company,
                            price_type: priceType
                        });
                    }
                });
                
                if (priceColumns.length === 0) {
                    alert('请至少添加一个价格列映射');
                    return;
                }
                
                // 构建映射数据
                const mapping = {
                    product: productColumn,
                    date: $('#date-column').val(),
                    price_cols: priceColumns
                };
                
                // 发送请求
                $.ajax({
                    url: '/api/import/map',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        temp_id: '{{ temp_id }}',
                        mapping: mapping,
                        global_month: $('#global-month').val(),
                        conflict_mode: $('#conflict-mode').val()
                    }),
                    success: function(response) {
                        if (response.success) {
                            showPreviewResults(response);
                            $('#import-btn').prop('disabled', false);
                        } else {
                            alert('预检查失败: ' + response.error);
                        }
                    },
                    error: function(xhr) {
                        alert('请求失败: ' + (xhr.responseJSON?.error || xhr.statusText));
                    }
                });
            });
            
            // 开始导入
            $('#import-btn').click(function() {
                if (!confirm('确认开始导入数据？')) {
                    return;
                }
                
                // 收集映射数据（与预检查相同）
                const productColumn = $('#product-column').val();
                const priceColumns = [];
                $('.price-mapping').each(function() {
                    const column = $(this).find('.price-column').val();
                    const company = $(this).find('.company-name').val();
                    const priceType = $(this).find('.price-type').val();
                    
                    if (column && company) {
                        priceColumns.push({
                            column: column,
                            company: company,
                            price_type: priceType
                        });
                    }
                });
                
                const mapping = {
                    product: productColumn,
                    date: $('#date-column').val(),
                    price_cols: priceColumns
                };
                
                // 显示进度区域
                $('#mapping-form').hide();
                $('#preview-results').hide();
                $('#import-progress').show();
                
                // 发送导入请求
                $.ajax({
                    url: '/api/import/execute',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        temp_id: '{{ temp_id }}',
                        mapping: mapping,
                        global_month: $('#global-month').val(),
                        conflict_mode: $('#conflict-mode').val()
                    }),
                    success: function(response) {
                        if (response.success) {
                            // 开始轮询任务状态
                            pollImportStatus(response.task_id);
                        } else {
                            alert('导入失败: ' + response.error);
                            $('#mapping-form').show();
                            $('#import-progress').hide();
                        }
                    },
                    error: function(xhr) {
                        alert('请求失败: ' + (xhr.responseJSON?.error || xhr.statusText));
                        $('#mapping-form').show();
                        $('#import-progress').hide();
                    }
                });
            });
            
            // 显示预检查结果
            function showPreviewResults(data) {
                const previewTable = $('#preview-table tbody');
                previewTable.empty();
                
                // 填充预览表格
                data.preview.forEach(function(row) {
                    let matchesHtml = '';
                    if (row.matches && row.matches.length > 0) {
                        matchesHtml = `已匹配: ${row.matches[0][1]} (${row.matches[0][3]}%)`;
                    } else {
                        matchesHtml = '将新增产品';
                    }
                    
                    let pricesHtml = '';
                    row.prices.forEach(function(price) {
                        pricesHtml += `<div>${price.company}: ${price.value}</div>`;
                    });
                    
                    previewTable.append(`
                        <tr>
                            <td>${row.row}</td>
                            <td>${row.product}</td>
                            <td>${row.normalized}</td>
                            <td>${matchesHtml}</td>
                            <td>${pricesHtml}</td>
                        </tr>
                    `);
                });
                
                // 显示冲突
                if (data.conflicts && data.conflicts.length > 0) {
                    const conflictsList = $('#conflicts-list');
                    conflictsList.empty();
                    
                    data.conflicts.forEach(function(conflict) {
                        conflictsList.append(`
                            <div>第${conflict.row}行: ${conflict.product} - ${conflict.company} 已存在价格 ${conflict.existing_price}, 新价格: ${conflict.new_price}</div>
                        `);
                    });
                    
                    $('#conflicts-container').show();
                } else {
                    $('#conflicts-container').hide();
                }
                
                $('#preview-results').show();
            }
            
            // 轮询导入状态
            function pollImportStatus(taskId) {
                const progressInterval = setInterval(function() {
                    $.get('/api/import/status/' + taskId, function(response) {
                        if (response.status === 'completed' || response.status === 'failed') {
                            clearInterval(progressInterval);
                            
                            if (response.status === 'completed') {
                                $('#progress-bar').css('width', '100%');
                                $('#progress-text').text(`导入完成: 成功${response.success}行, 失败${response.failed}行`);
                                
                                setTimeout(function() {
                                    alert(`导入完成: 成功${response.success}行, 失败${response.failed}行`);
                                    window.location.href = '/smart_quote';
                                }, 1000);
                            } else {
                                $('#progress-bar').addClass('bg-danger');
                                $('#progress-text').text(`导入失败: ${response.error_msg || '未知错误'}`);
                            }
                        } else {
                            const total = response.total || 1;
                            const done = (response.success || 0) + (response.failed || 0);
                            const percent = Math.round((done / total) * 100);
                            
                            $('#progress-bar').css('width', percent + '%');
                            $('#progress-text').text(`处理中: ${done}/${total} 行 (${percent}%)`);
                        }
                    });
                }, 1000);
            }
            
            // 初始添加一个价格映射
            $('#add-price-mapping').click();
        });
    </script>
</body>
</html>