{% extends "includes/base_with_sidebar.html" %}

{% block title %}销售订单 - 智管系统{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .table-container {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .search-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .action-buttons .btn {
        margin-right: 5px;
        margin-bottom: 5px;
    }
    .pagination-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }
    .table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    .status-confirmed {
        background-color: #cfe2ff;
        color: #084298;
    }
    .status-shipped {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    .status-completed {
        background-color: #d1e7dd;
        color: #0a3622;
    }
    .status-cancelled {
        background-color: #f8d7da;
        color: #842029;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-cart-check-fill text-info"></i> 销售订单
        </h2>
        <button class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#addOrderModal">
            <i class="bi bi-plus-circle"></i> 新增订单
        </button>
    </div>

    <!-- 搜索框 -->
    <div class="search-box">
        <form id="searchForm" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">订单编号</label>
                <input type="text" class="form-control" id="searchOrderNo" placeholder="输入订单编号">
            </div>
            <div class="col-md-3">
                <label class="form-label">客户名称</label>
                <input type="text" class="form-control" id="searchCustomer" placeholder="输入客户名称">
            </div>
            <div class="col-md-2">
                <label class="form-label">订单状态</label>
                <select class="form-select" id="searchStatus">
                    <option value="">全部状态</option>
                    <option value="pending">待确认</option>
                    <option value="confirmed">已确认</option>
                    <option value="shipped">已发货</option>
                    <option value="completed">已完成</option>
                    <option value="cancelled">已取消</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-info text-white">
                        <i class="bi bi-search"></i> 搜索
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetSearch()">
                        <i class="bi bi-arrow-clockwise"></i> 重置
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- 表格容器 -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>订单编号</th>
                        <th>客户名称</th>
                        <th>订单日期</th>
                        <th>订单金额</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页信息 -->
        <div class="pagination-info">
            <div>
                <span id="recordInfo">共 0 条记录</span>
                <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="pageSizeSelect" onchange="changePageSize()">
                    <option value="10">10条/页</option>
                    <option value="15" selected>15条/页</option>
                    <option value="20">20条/页</option>
                    <option value="50">50条/页</option>
                </select>
            </div>
            <nav>
                <ul class="pagination mb-0" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- 新增订单模态框 -->
<div class="modal fade" id="addOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增销售订单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addOrderForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">订单编号 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="order_no" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">客户名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="customer_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">订单日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="order_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">订单金额 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="total_amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">订单状态</label>
                        <select class="form-select" name="status">
                            <option value="pending">待确认</option>
                            <option value="confirmed">已确认</option>
                            <option value="shipped">已发货</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" name="note" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info text-white" onclick="addOrder()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑订单模态框 -->
<div class="modal fade" id="editOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑销售订单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderForm">
                    <input type="hidden" name="id" id="editOrderId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">订单编号 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="order_no" id="editOrderNo" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">客户名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="customer_name" id="editCustomerName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">订单日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="order_date" id="editOrderDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">订单金额 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="total_amount" id="editTotalAmount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">订单状态</label>
                        <select class="form-select" name="status" id="editStatus">
                            <option value="pending">待确认</option>
                            <option value="confirmed">已确认</option>
                            <option value="shipped">已发货</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" name="note" id="editNote" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info text-white" onclick="updateOrder()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let pageSize = 15;
let totalRecords = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    
    // 设置默认日期为今天
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('#addOrderForm input[name="order_date"]').value = today;
    
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 1;
        loadOrders();
    });
});

async function loadOrders() {
    const orderNo = document.getElementById('searchOrderNo').value;
    const customer = document.getElementById('searchCustomer').value;
    const status = document.getElementById('searchStatus').value;
    
    try {
        const response = await fetch(`/api/sales_orders?page=${currentPage}&page_size=${pageSize}&order_no=${orderNo}&customer=${customer}&status=${status}`);
        const data = await response.json();
        
        if (data.success) {
            displayOrders(data.data);
            totalRecords = data.total;
            updatePagination(data.total);
        } else {
            alert(data.message || '加载失败');
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('orderTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">加载失败，请重试</td></tr>';
    }
}

function displayOrders(orders) {
    const tbody = document.getElementById('orderTableBody');
    
    if (!Array.isArray(orders) || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无数据</td></tr>';
        return;
    }
    
    tbody.innerHTML = orders.map(order => {
        const statusMap = {
            'pending': { text: '待确认', class: 'status-pending' },
            'confirmed': { text: '已确认', class: 'status-confirmed' },
            'shipped': { text: '已发货', class: 'status-shipped' },
            'completed': { text: '已完成', class: 'status-completed' },
            'cancelled': { text: '已取消', class: 'status-cancelled' }
        };
        const status = statusMap[order.status] || { text: order.status, class: 'status-pending' };
        
        return `
        <tr>
            <td><strong>${order.order_no || '-'}</strong></td>
            <td>${order.customer_name || '-'}</td>
            <td>${order.order_date || '-'}</td>
            <td><strong class="text-success">¥${parseFloat(order.total_amount || 0).toFixed(2)}</strong></td>
            <td><span class="status-badge ${status.class}">${status.text}</span></td>
            <td>${order.created_at || '-'}</td>
            <td class="action-buttons">
                <button class="btn btn-sm btn-primary" onclick="editOrder(${order.id})">
                    <i class="bi bi-pencil"></i> 编辑
                </button>
                <button class="btn btn-sm btn-info text-white" onclick="viewDetails(${order.id})">
                    <i class="bi bi-eye"></i> 详情
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.id})">
                    <i class="bi bi-trash"></i> 删除
                </button>
            </td>
        </tr>
        `;
    }).join('');
}

function updatePagination(total) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.getElementById('pagination');
    const recordInfo = document.getElementById('recordInfo');
    
    recordInfo.textContent = `共 ${total} 条记录`;
    
    let html = '';
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">上一页</a>
    </li>`;
    
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
            </li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">下一页</a>
    </li>`;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    const totalPages = Math.ceil(totalRecords / pageSize);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadOrders();
}

function changePageSize() {
    pageSize = parseInt(document.getElementById('pageSizeSelect').value);
    currentPage = 1;
    loadOrders();
}

function resetSearch() {
    document.getElementById('searchOrderNo').value = '';
    document.getElementById('searchCustomer').value = '';
    document.getElementById('searchStatus').value = '';
    currentPage = 1;
    loadOrders();
}

async function addOrder() {
    const form = document.getElementById('addOrderForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/api/sales_orders', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(Object.fromEntries(formData))
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('新增成功');
            bootstrap.Modal.getInstance(document.getElementById('addOrderModal')).hide();
            form.reset();
            loadOrders();
        } else {
            alert(data.message || '新增失败');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('新增失败，请重试');
    }
}

async function editOrder(id) {
    try {
        const response = await fetch(`/api/sales_orders/${id}`);
        const data = await response.json();
        
        if (data.success) {
            const order = data.data;
            document.getElementById('editOrderId').value = order.id;
            document.getElementById('editOrderNo').value = order.order_no || '';
            document.getElementById('editCustomerName').value = order.customer_name || '';
            document.getElementById('editOrderDate').value = order.order_date || '';
            document.getElementById('editTotalAmount').value = order.total_amount || 0;
            document.getElementById('editStatus').value = order.status || 'pending';
            document.getElementById('editNote').value = order.note || '';
            
            new bootstrap.Modal(document.getElementById('editOrderModal')).show();
        } else {
            alert(data.message || '获取数据失败');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('获取数据失败，请重试');
    }
}

async function updateOrder() {
    const form = document.getElementById('editOrderForm');
    const formData = new FormData(form);
    const id = formData.get('id');
    
    try {
        const response = await fetch(`/api/sales_orders/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(Object.fromEntries(formData))
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('更新成功');
            bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
            loadOrders();
        } else {
            alert(data.message || '更新失败');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('更新失败，请重试');
    }
}

function viewDetails(id) {
    alert('订单详情功能开发中...');
    // 可以跳转到详情页面或显示模态框
}

async function deleteOrder(id) {
    if (!confirm('确定要删除这个订单吗？')) return;
    
    try {
        const response = await fetch(`/api/sales_orders/${id}`, {method: 'DELETE'});
        const data = await response.json();
        
        if (data.success) {
            alert('删除成功');
            loadOrders();
        } else {
            alert(data.message || '删除失败');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('删除失败，请重试');
    }
}
</script>
{% endblock %}